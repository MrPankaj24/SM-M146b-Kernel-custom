name: Build Samsung M14 5G Kernel (Fixed Branch)

permissions:
  contents: write

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Workflow
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git build-essential bc bison flex libssl-dev libncurses5-dev libncursesw5-dev \
        libelf-dev cmake cpio unzip rsync device-tree-compiler python3

    - name: Clone Kernel Source
      run: |
        # Fixed: Changed branch from 'android13-5.15-lts' to 'android13-5.15'
        git clone https://github.com/devhunter1/android_kernel_samsung_s5e8535.git -b android13-5.15 kernel_workspace
      
    - name: Clone Toolchains
      run: |
        # Google's Clang 17 (Official Android Toolchain)
        mkdir -p clang
        wget https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/master/clang-r487747c.tar.gz
        tar -C clang/ -zxvf clang-r487747c.tar.gz
        
        # GCC 4.9 (Legacy, often needed for Samsung kernels)
        git clone https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-android-4.9.git --depth=1 gcc64
        git clone https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_arm_arm-linux-androideabi-4.9.git --depth=1 gcc32

    - name: Setup KernelSU-Next (Root)
      working-directory: kernel_workspace
      run: |
        # Cloning KernelSU-Next
        curl -LSs "https://raw.githubusercontent.com/rifsxd/KernelSU-Next/next/kernel/setup.sh" | bash -s next-susfs
        
        # NOTE: SUSFS patches are DISABLED to prevent build failure.
        # We are only enabling the core KernelSU functionality.

    - name: Configure Kernel (LXC + Docker)
      working-directory: kernel_workspace
      run: |
        # Set environment variables for the compiler
        export PATH=$GITHUB_WORKSPACE/clang/bin:$GITHUB_WORKSPACE/gcc64/bin:$GITHUB_WORKSPACE/gcc32/bin:$PATH
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-android-
        export CROSS_COMPILE_ARM32=arm-linux-androideabi-
        export CC=clang
        export CLANG_TRIPLE=aarch64-linux-gnu-

        # Clean build
        make clean && make mrproper

        # Load the default configuration for Samsung M14 (m14x)
        make m14x_defconfig

        # Enable KernelSU
        ./scripts/config --file .config --enable CONFIG_KSU
        
        # Enable LXC and Docker Support (Containers)
        ./scripts/config --file .config --enable CONFIG_NAMESPACES
        ./scripts/config --file .config --enable CONFIG_NET_NS
        ./scripts/config --file .config --enable CONFIG_PID_NS
        ./scripts/config --file .config --enable CONFIG_IPC_NS
        ./scripts/config --file .config --enable CONFIG_UTS_NS
        ./scripts/config --file .config --enable CONFIG_CGROUPS
        ./scripts/config --file .config --enable CONFIG_CGROUP_CPUACCT
        ./scripts/config --file .config --enable CONFIG_CGROUP_DEVICE
        ./scripts/config --file .config --enable CONFIG_CGROUP_FREEZER
        ./scripts/config --file .config --enable CONFIG_CGROUP_SCHED
        ./scripts/config --file .config --enable CONFIG_CPUSETS
        ./scripts/config --file .config --enable CONFIG_MEMCG
        ./scripts/config --file .config --enable CONFIG_KEYS
        ./scripts/config --file .config --enable CONFIG_VETH
        ./scripts/config --file .config --enable CONFIG_BRIDGE
        ./scripts/config --file .config --enable CONFIG_BRIDGE_NETFILTER
        ./scripts/config --file .config --enable CONFIG_IP_NF_FILTER
        ./scripts/config --file .config --enable CONFIG_IP_NF_TARGET_MASQUERADE
        ./scripts/config --file .config --enable CONFIG_NETFILTER_XT_MATCH_ADDRTYPE
        ./scripts/config --file .config --enable CONFIG_NETFILTER_XT_MATCH_CONNTRACK
        ./scripts/config --file .config --enable CONFIG_NETFILTER_XT_MATCH_IPVS
        ./scripts/config --file .config --enable CONFIG_IP_VS
        ./scripts/config --file .config --enable CONFIG_IP_VS_PROTO_TCP
        ./scripts/config --file .config --enable CONFIG_IP_VS_PROTO_UDP
        ./scripts/config --file .config --enable CONFIG_IP_VS_RR
        ./scripts/config --file .config --enable CONFIG_IP_VS_NFCT
        ./scripts/config --file .config --enable CONFIG_POSIX_MQUEUE
        
        # Update config
        make olddefconfig

    - name: Build Kernel
      working-directory: kernel_workspace
      run: |
        export PATH=$GITHUB_WORKSPACE/clang/bin:$GITHUB_WORKSPACE/gcc64/bin:$GITHUB_WORKSPACE/gcc32/bin:$PATH
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-android-
        export CROSS_COMPILE_ARM32=arm-linux-androideabi-
        export CC=clang
        export CLANG_TRIPLE=aarch64-linux-gnu-

        # Build the kernel image (Image.gz and dtb)
        make -j$(nproc) Image.gz dtbs

    - name: Prepare Artifacts
      run: |
        mkdir -p release
        cp kernel_workspace/arch/arm64/boot/Image.gz release/
        find kernel_workspace/arch/arm64/boot/dts/samsung -name "*.dtb" -exec cp {} release/ \;
        
    - name: Upload Build
      uses: actions/upload-artifact@v4
      with:
        name: Samsung_M14_Kernel_KSU_Docker
        path: release/
