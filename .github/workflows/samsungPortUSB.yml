- name: Initialize and Sync Kernel Source by Pankaj
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        FORMATTED_BRANCH="android13-5.15-lts"
        repo init -u https://android.googlesource.com/kernel/manifest -b common-${FORMATTED_BRANCH} --repo-rev=v2.16 --depth=1
        repo sync -c -j$(nproc --all) --fail-fast --no-tags --force-sync --no-clone-bundle

    - name: Inject Samsung USB Stack & Apply Fixes
      run: |
        # 1. Clone Samsung source for M146B
        git clone https://github.com/MrPankaj24/SM-M146B-Kernel-Source.git --depth=1 samsung_src
        
        # 2. Port USB DWC3 & Gadget Drivers
        rm -rf ${{ env.KERNEL_ROOT }}/common/drivers/usb/dwc3
        cp -r samsung_src/drivers/usb/dwc3 ${{ env.KERNEL_ROOT }}/common/drivers/usb/
        cp -r samsung_src/drivers/usb/gadget/function/* ${{ env.KERNEL_ROOT }}/common/drivers/usb/gadget/function/
        
        # 3. Apply Module Check Bypass (The "Solution" you requested)
        # Changes return 0 (false) to return 1 (true) in module loading failure checks
        TARGET_FILE="${{ env.KERNEL_ROOT }}/common/kernel/module.c"
        sed -i '/bad_version:/{:a;n;/return 0;/{s/return 0;/return 1;/;b};ba}' "$TARGET_FILE"
        
        # 4. Bypass savedefconfig Integrity Error
        sed -i 's/POST_DEFCONFIG_CMDS="check_defconfig"//' ${{ env.KERNEL_ROOT }}/common/build.config.gki.aarch64 || true
        
        echo "Bypass logic applied and drivers injected."

    - name: Enable Advanced Features (SUSFS, Wireguard, etc.)
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        # Appending your specific feature set
        cat >> "${{ env.DEFCONFIG_FRAGMENT }}" << 'EOF'
        # Root & Stealth
        CONFIG_KSU=y
        CONFIG_KSU_SUSFS=y
        
        # USB Driver Support (M146B Specific)
        CONFIG_USB_DWC3_EXYNOS=y
        CONFIG_USB_F_RNDIS=y
        CONFIG_USB_CONFIGFS_F_TETHER=y
        
        # Network Features
        CONFIG_WIREGUARD=y
        EOF
